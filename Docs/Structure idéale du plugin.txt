ğŸ— Structure idÃ©ale du plugin

Nom :
leadbridge

Structure :

leadbridge/
â”‚
â”œâ”€â”€ leadbridge.php
â”œâ”€â”€ includes/
â”‚   â”œâ”€â”€ class-leadbridge-core.php
â”‚   â”œâ”€â”€ class-leadbridge-sender.php
â”‚   â”œâ”€â”€ class-leadbridge-logger.php
â”‚   â”œâ”€â”€ class-leadbridge-utils.php
â”‚
â””â”€â”€ config/
    â””â”€â”€ endpoints.php

1ï¸âƒ£ Fichier principal : leadbridge.php

Il charge les classes et initialise le systÃ¨me.

<?php
/**
 * Plugin Name: LeadBridge
 * Description: Orchestrateur de leads multi-endpoints.
 * Version: 1.0
 */

if (!defined('ABSPATH')) exit;

require_once plugin_dir_path(__FILE__) . 'includes/class-leadbridge-core.php';

new LeadBridge_Core();

2ï¸âƒ£ Core : Hook avec Fluent Forms

Fluent Forms dÃ©clenche :

add_action('fluentform_submission_inserted', function($entryId, $formData, $form) {

    LeadBridge_Core::handle_submission($form->id, $formData);

}, 10, 3);


On ne dÃ©pend pas du nom des champs visuels.
On dÃ©pend des slugs Fluent Forms.

3ï¸âƒ£ Configuration centralisÃ©e par site

Dans config/endpoints.php :

return [

    1 => [ // ID du formulaire Fluent
        'dashboard_url' => 'https://dashboard.webylead.com/api/XXXX',
        'bridge_url'    => 'http://app.webylead.com/prospect/devis-XXX',

        'mapping' => [
            'nom'      => 'Nom',
            'prenom'   => 'PrÃ©nom',
            'email'    => 'Email',
            'telephone'=> 'TÃ©lÃ©phone',
            'cp'       => 'CP',
        ],

        'fixed_fields' => [
            'utm_source' => 'Affiliation'
        ]
    ]

];


Chaque site aura son propre fichier config.
Aucun code mÃ©tier dupliquÃ©.

4ï¸âƒ£ Classe Sender (transport HTTP propre)

On utilise wp_remote_post.

class LeadBridge_Sender {

    public static function send($url, $payload) {

        $response = wp_remote_post($url, [
            'body' => $payload,
            'timeout' => 15,
            'headers' => [
                'Content-Type' => 'application/x-www-form-urlencoded'
            ]
        ]);

        if (is_wp_error($response)) {
            return ['ok' => false, 'error' => $response->get_error_message()];
        }

        return [
            'ok' => wp_remote_retrieve_response_code($response) >= 200 
                    && wp_remote_retrieve_response_code($response) < 300,
            'code' => wp_remote_retrieve_response_code($response),
            'body' => wp_remote_retrieve_body($response)
        ];
    }
}

5ï¸âƒ£ Logger JSONL (comme ton meilleur site actuel)

Fichier :
wp-content/uploads/leadbridge.log

class LeadBridge_Logger {

    public static function log($target, $payload, $result) {

        $record = [
            'ts' => current_time('c'),
            'target' => $target,
            'payload' => self::mask($payload),
            'result' => $result
        ];

        $file = wp_upload_dir()['basedir'] . '/leadbridge.log';

        file_put_contents(
            $file,
            json_encode($record, JSON_UNESCAPED_UNICODE) . PHP_EOL,
            FILE_APPEND | LOCK_EX
        );
    }

    private static function mask($payload) {
        if (isset($payload['Email'])) {
            $payload['Email'] = substr($payload['Email'], 0, 3) . '***';
        }
        return $payload;
    }
}


TraÃ§abilitÃ© = puissance.

6ï¸âƒ£ Gestion spÃ©ciale (ex : resolve_city IGN)

Dans class-leadbridge-utils.php

MÃªme logique que ton ancien code, mais isolÃ©e :

class LeadBridge_Utils {

    public static function resolve_city($cp) {

        if (!preg_match('/^\d{5}$/', $cp)) {
            return 'Non prÃ©cisÃ©e';
        }

        $response = wp_remote_get(
            'https://apicarto.ign.fr/api/codes-postaux/communes/' . $cp,
            ['timeout' => 8]
        );

        if (is_wp_error($response)) return 'Non prÃ©cisÃ©e';

        $data = json_decode(wp_remote_retrieve_body($response), true);

        return $data[0]['nomCommune'] ?? 'Non prÃ©cisÃ©e';
    }
}

ğŸ” SÃ©curitÃ© minimale obligatoire

Ajoute :

Honeypot Fluent Forms

reCAPTCHA

Limite de soumissions par IP

Validation stricte email/tÃ©lÃ©phone

VÃ©rification domaine referrer si nÃ©cessaire

Un lead system attire les bots comme le miel attire les fourmis.

ğŸš€ Vision long terme

Tu peux ajouter plus tard :

Retry automatique si HTTP != 200

File dâ€™attente WP-Cron

Interface admin pour voir les erreurs

Envoi Slack en cas dâ€™Ã©chec

Signature HMAC des payloads

Identifiant unique par lead

Ã€ ce moment-lÃ , tu nâ€™as plus un plugin.
Tu as une mini-plateforme de routing.

ğŸ¯ RÃ©sumÃ© stratÃ©gique

Fluent Forms = interface utilisateur
LeadBridge = cerveau
Endpoints = configuration

SÃ©paration claire.
Maintenance simple.
ScalabilitÃ© naturelle.
Logs exploitables.

Tu passes dâ€™un patchwork PHP Ã  une architecture cohÃ©rente.




